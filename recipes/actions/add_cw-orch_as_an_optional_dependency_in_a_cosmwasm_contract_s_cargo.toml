{
    "label": "others",
    "workflow": [
        {
            "step": 1,
            "label": "backend",
            "introduction": "Step 1 provides a Python helper that loads the projects Cargo.toml as a dictionary so later steps can modify it safely.",
            "code": "import os\nfrom pathlib import Path\nfrom typing import Any, Dict\n\ntry:\n    import toml\nexcept ImportError as exc:\n    raise ImportError('The toml package is required. Install it with: pip install toml') from exc\n\n\ndef load_cargo_toml(project_root: str = '.') -> Dict[str, Any]:\n    '''\n    Load the Cargo.toml file from the given project root and return it as a dict.\n\n    :param project_root: Path to the contract workspace root (where Cargo.toml lives).\n    :raises FileNotFoundError: If Cargo.toml is missing.\n    :raises RuntimeError: If the file cannot be parsed as TOML.\n    '''\n    path = Path(project_root).resolve() / 'Cargo.toml'\n    if not path.is_file():\n        raise FileNotFoundError(f'Cargo.toml not found at {path}')\n\n    try:\n        with path.open('r', encoding='utf-8') as fp:\n            data = toml.load(fp)\n    except Exception as exc:\n        raise RuntimeError(f'Failed to parse {path}: {exc}') from exc\n\n    return data\n\n\nif __name__ == '__main__':\n    # Example usage from the command line:\n    #   python load_cargo.py /path/to/contract\n    import sys\n\n    root = sys.argv[1] if len(sys.argv) > 1 else '.'\n    cargo = load_cargo_toml(root)\n    print(cargo)\n",
            "usage": "from cargo_tools import load_cargo_toml\ncargo = load_cargo_toml('/path/to/contract')\nprint(cargo.get('dependencies', {}))"
        },
        {
            "step": 2,
            "label": "backend",
            "introduction": "Step 2 adds or updates an optional cw-orch dependency in the Cargo.toml [dependencies] section using a provided version string.",
            "code": "import os\nfrom pathlib import Path\nfrom typing import Any, Dict\n\ntry:\n    import toml\nexcept ImportError as exc:\n    raise ImportError('The toml package is required. Install it with: pip install toml') from exc\n\n\ndef load_cargo_toml(project_root: str = '.') -> Dict[str, Any]:\n    '''Load Cargo.toml from project_root.'''\n    path = Path(project_root).resolve() / 'Cargo.toml'\n    if not path.is_file():\n        raise FileNotFoundError(f'Cargo.toml not found at {path}')\n\n    try:\n        with path.open('r', encoding='utf-8') as fp:\n            data = toml.load(fp)\n    except Exception as exc:\n        raise RuntimeError(f'Failed to parse {path}: {exc}') from exc\n\n    return data\n\n\ndef save_cargo_toml(data: Dict[str, Any], project_root: str = '.') -> None:\n    '''Write the Cargo.toml data structure back to disk.'''\n    path = Path(project_root).resolve() / 'Cargo.toml'\n    try:\n        with path.open('w', encoding='utf-8') as fp:\n            toml.dump(data, fp)\n    except Exception as exc:\n        raise RuntimeError(f'Failed to write {path}: {exc}') from exc\n\n\ndef add_cw_orch_optional_dependency(project_root: str = '.', version: str = '0.18.0') -> None:\n    '''\n    Ensure that cw-orch is present in [dependencies] as an optional dependency.\n\n    This will add or update an entry equivalent to:\n        cw-orch = { version = 'X.Y.Z', optional = true }\n    '''\n    cargo = load_cargo_toml(project_root)\n    dependencies = cargo.setdefault('dependencies', {})\n\n    existing = dependencies.get('cw-orch')\n\n    desired = {'version': version, 'optional': True}\n\n    if existing is None:\n        # Add new entry.\n        dependencies['cw-orch'] = desired\n    elif isinstance(existing, str):\n        # Existing is a bare version string; upgrade to table-style dependency.\n        desired['version'] = version or existing\n        dependencies['cw-orch'] = desired\n    elif isinstance(existing, dict):\n        # Update any existing table-style dependency with our desired fields.\n        existing.update(desired)\n    else:\n        raise TypeError('Unexpected type for cw-orch dependency in Cargo.toml')\n\n    save_cargo_toml(cargo, project_root)\n\n\nif __name__ == '__main__':\n    # Example:\n    #   python add_cw_orch_dep.py /path/to/contract 0.18.0\n    import sys\n\n    root = sys.argv[1] if len(sys.argv) > 1 else '.'\n    ver = sys.argv[2] if len(sys.argv) > 2 else '0.18.0'\n    add_cw_orch_optional_dependency(root, ver)\n    print('Updated Cargo.toml with cw-orch dependency')\n",
            "usage": "from cargo_tools import add_cw_orch_optional_dependency\nadd_cw_orch_optional_dependency('/path/to/contract', version='0.18.0')"
        },
        {
            "step": 3,
            "label": "backend",
            "introduction": "Step 3 configures the Cargo.toml [features] section so that enabling the cw-orch feature activates the cw-orch dependency.",
            "code": "import os\nfrom pathlib import Path\nfrom typing import Any, Dict\n\ntry:\n    import toml\nexcept ImportError as exc:\n    raise ImportError('The toml package is required. Install it with: pip install toml') from exc\n\n\ndef load_cargo_toml(project_root: str = '.') -> Dict[str, Any]:\n    '''Load Cargo.toml from project_root.'''\n    path = Path(project_root).resolve() / 'Cargo.toml'\n    if not path.is_file():\n        raise FileNotFoundError(f'Cargo.toml not found at {path}')\n\n    try:\n        with path.open('r', encoding='utf-8') as fp:\n            data = toml.load(fp)\n    except Exception as exc:\n        raise RuntimeError(f'Failed to parse {path}: {exc}') from exc\n\n    return data\n\n\ndef save_cargo_toml(data: Dict[str, Any], project_root: str = '.') -> None:\n    '''Write the Cargo.toml data structure back to disk.'''\n    path = Path(project_root).resolve() / 'Cargo.toml'\n    try:\n        with path.open('w', encoding='utf-8') as fp:\n            toml.dump(data, fp)\n    except Exception as exc:\n        raise RuntimeError(f'Failed to write {path}: {exc}') from exc\n\n\ndef configure_cw_orch_feature(project_root: str = '.') -> None:\n    '''\n    Ensure the [features] section contains entries for cw-orch that look like:\n        default = []\n        cw-orch = ['dep:cw-orch']\n\n    Existing settings are preserved where possible.\n    '''\n    cargo = load_cargo_toml(project_root)\n    features = cargo.setdefault('features', {})\n\n    default_feature = features.get('default')\n    if default_feature is None:\n        features['default'] = []\n    elif not isinstance(default_feature, list):\n        raise TypeError('The default feature in Cargo.toml must be a list')\n\n    cw_orch_feature = features.get('cw-orch')\n    if cw_orch_feature is None:\n        features['cw-orch'] = ['dep:cw-orch']\n    elif isinstance(cw_orch_feature, list):\n        if 'dep:cw-orch' not in cw_orch_feature:\n            cw_orch_feature.append('dep:cw-orch')\n    else:\n        raise TypeError('The cw-orch feature in Cargo.toml must be a list')\n\n    save_cargo_toml(cargo, project_root)\n\n\nif __name__ == '__main__':\n    # Example:\n    #   python configure_cw_orch_feature.py /path/to/contract\n    import sys\n\n    root = sys.argv[1] if len(sys.argv) > 1 else '.'\n    configure_cw_orch_feature(root)\n    print('Updated Cargo.toml features for cw-orch')\n",
            "usage": "from cargo_tools import configure_cw_orch_feature\nconfigure_cw_orch_feature('/path/to/contract')"
        },
        {
            "step": 4,
            "label": "backend",
            "introduction": "Step 4 runs a cargo command with the cw-orch feature enabled to verify that the workspace builds successfully.",
            "code": "import subprocess\nfrom pathlib import Path\nfrom typing import Any, Dict\n\n\ndef verify_cargo_with_cw_orch(project_root: str = '.', cargo_subcommand: str = 'check') -> Dict[str, Any]:\n    '''\n    Run `cargo <subcommand> --features cw-orch` from the given project root\n    to verify that the workspace builds with cw-orch enabled.\n\n    :param project_root: Path to the contract workspace root.\n    :param cargo_subcommand: Either 'check' or 'test' (or another valid cargo subcommand).\n    :return: Dict with keys: returncode, stdout, stderr, command, cwd.\n    :raises FileNotFoundError: If cargo is not installed or not on PATH.\n    :raises RuntimeError: If the command fails (non-zero exit code).\n    '''\n    root = Path(project_root).resolve()\n    if not root.is_dir():\n        raise FileNotFoundError(f'Project root directory not found: {root}')\n\n    cmd = ['cargo', cargo_subcommand, '--features', 'cw-orch']\n\n    try:\n        proc = subprocess.run(\n            cmd,\n            cwd=str(root),\n            capture_output=True,\n            text=True,\n            check=False,\n        )\n    except FileNotFoundError as exc:\n        raise FileNotFoundError('cargo executable not found. Is Rust installed and on PATH?') from exc\n\n    result: Dict[str, Any] = {\n        'returncode': proc.returncode,\n        'stdout': proc.stdout,\n        'stderr': proc.stderr,\n        'command': ' '.join(cmd),\n        'cwd': str(root),\n    }\n\n    if proc.returncode != 0:\n        raise RuntimeError(\n            f'Command failed with exit code {proc.returncode}. '\n            f'Stdout: {proc.stdout}\\nStderr: {proc.stderr}'\n        )\n\n    return result\n\n\nif __name__ == '__main__':\n    # Example:\n    #   python verify_cargo_build.py /path/to/contract check\n    import sys\n\n    root = sys.argv[1] if len(sys.argv) > 1 else '.'\n    sub = sys.argv[2] if len(sys.argv) > 2 else 'check'\n    res = verify_cargo_with_cw_orch(root, sub)\n    print('cargo command succeeded:')\n    print('  command:', res['command'])\n    print('  cwd:', res['cwd'])\n",
            "usage": "from cargo_tools import verify_cargo_with_cw_orch\nresult = verify_cargo_with_cw_orch('/path/to/contract', cargo_subcommand='check')\nprint(result['returncode'], 'OK')"
        }
    ]
}