{
    "label": "others",
    "workflow": [
        {
            "step": 1,
            "label": "backend",
            "introduction": "Step 1 exposes a FastAPI endpoint that verifies whether the target directory already contains the test-net configuration created by `simd testnet init-files`.  If the files are missing and the caller sets `auto_init=true`, the endpoint will automatically execute the init command; otherwise it just reports that initialization is required.",
            "code": "# backend/testnet_manager.py\nfrom fastapi import FastAPI, HTTPException\nfrom pathlib import Path\nimport subprocess\nimport os\n\napp = FastAPI()\n\n# In-memory registry of running processes (shared by later steps)\n_processes = {}\n\ndef _run_cmd(cmd: list[str]) -> subprocess.CompletedProcess:\n    \"\"\"Helper that executes an external command and raises if it fails.\"\"\"\n    proc = subprocess.run(cmd, capture_output=True, text=True)\n    if proc.returncode != 0:\n        raise RuntimeError(f\"Command failed: {' '.join(cmd)}\\n{proc.stderr}\")\n    return proc\n\ndef ensure_testnet_files(home_dir: str | None = None,\n                          auto_init: bool = False,\n                          validators: int = 2) -> dict:\n    \"\"\"Checks (and optionally creates) test-net files for simd.\"\"\"\n    # Resolve the directory (default: $HOME/.simapp )\n    if home_dir is None:\n        home_dir = str(Path.home() / \".simapp\")\n    home_path = Path(home_dir)\n\n    # Very light-weight existence test \u2013 looks for any genesis.json file.\n    config_exists = any(home_path.glob(\"**/genesis.json\"))\n\n    # If everything is in place, just return the positive status.\n    if config_exists:\n        return {\"exists\": True, \"path\": home_dir}\n\n    # Files are missing \u2013 either tell the caller or create them.\n    if not auto_init:\n        return {\n            \"exists\": False,\n            \"requires_init\": True,\n            \"path\": home_dir,\n            \"hint\": \"POST again with auto_init=true or run `simd testnet init-files` manually.\"\n        }\n\n    # Initialise the directory.\n    cmd = [\n        \"simd\", \"testnet\", \"init-files\",\n        \"--v\", str(validators),            # number of validators\n        \"--output-dir\", home_dir\n    ]\n    proc = _run_cmd(cmd)\n    return {\n        \"exists\": True,\n        \"init_performed\": True,\n        \"path\": home_dir,\n        \"stdout\": proc.stdout\n    }\n\n@app.post(\"/api/ensure-testnet-files\")\nasync def api_ensure_testnet_files(home_dir: str | None = None,\n                                   auto_init: bool = False,\n                                   validators: int = 2):\n    \"\"\"HTTP wrapper around ensure_testnet_files.\"\"\"\n    try:\n        return ensure_testnet_files(home_dir, auto_init, validators)\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))",
            "usage": "POST /api/ensure-testnet-files with JSON body, e.g.:\n{\n  \"home_dir\": \"/Users/alice/.simapp\",\n  \"auto_init\": false,\n  \"validators\": 2\n}"
        },
        {
            "step": 2,
            "label": "backend",
            "introduction": "Step 2 starts the multi-validator test-net in a background process (`subprocess.Popen`) and stores the handle in an in-memory registry so that other endpoints (e.g. log streaming) can reference it.",
            "code": "# Add this below the contents of testnet_manager.py (Step 1)\nimport subprocess\n\n\ndef start_testnet(home_dir: str) -> dict:\n    \"\"\"Launch `simd testnet start --home <dir>` as a managed background process.\"\"\"\n    if not Path(home_dir).exists():\n        raise FileNotFoundError(f\"The directory {home_dir} does not exist; run Step 1 first.\")\n\n    # If a process is already running, avoid spawning another one.\n    existing = _processes.get(home_dir)\n    if existing and existing.poll() is None:\n        return {\"started\": False, \"message\": \"Test-net is already running.\", \"pid\": existing.pid}\n\n    cmd = [\"simd\", \"testnet\", \"start\", \"--home\", home_dir]\n    proc = subprocess.Popen(\n        cmd,\n        stdout=subprocess.PIPE,\n        stderr=subprocess.STDOUT,\n        text=True,\n        bufsize=1  # line-buffered so we can stream logs\n    )\n    _processes[home_dir] = proc\n    return {\"started\": True, \"pid\": proc.pid, \"home_dir\": home_dir}\n\n\n@app.post(\"/api/start-testnet\")\nasync def api_start_testnet(home_dir: str):\n    \"\"\"HTTP endpoint that starts the test-net process.\"\"\"\n    try:\n        return start_testnet(home_dir)\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=str(e))",
            "usage": "POST /api/start-testnet with JSON body, e.g.:\n{\n  \"home_dir\": \"/Users/alice/.simapp\"\n}\nThe response will include `{ \"pid\": 12345 }` if the process started successfully."
        },
        {
            "step": 3,
            "label": "backend",
            "introduction": "Step 3 provides a streaming endpoint that forwards the `simd` stdout in real-time so the frontend can display logs until fast-sync completes and blocks are being produced.",
            "code": "# Append to testnet_manager.py (after Steps 1 & 2)\nfrom fastapi.responses import StreamingResponse\nimport asyncio\n\n@app.get(\"/api/testnet-logs\")\nasync def api_testnet_logs(home_dir: str):\n    \"\"\"Streams stdout from the running `simd testnet start` process.\"\"\"\n    proc = _processes.get(home_dir)\n    if not proc or proc.poll() is not None:\n        raise HTTPException(status_code=400, detail=\"No running test-net for the given home_dir\")\n\n    async def log_generator():\n        \"\"\"Asynchronously yield lines from the process output.\"\"\"\n        # Use the underlying file-descriptor in non-blocking mode.\n        while True:\n            line = proc.stdout.readline()\n            if line:\n                yield line\n            elif proc.poll() is not None:\n                break  # process ended\n            else:\n                await asyncio.sleep(0.1)  # avoid busy-loop\n\n    return StreamingResponse(log_generator(), media_type=\"text/plain\")",
            "usage": "GET /api/testnet-logs?home_dir=/Users/alice/.simapp\nThe response is a text/event-stream that the frontend can pipe directly to a log viewer."
        }
    ]
}