{
    "label": "others",
    "workflow": [
        {
            "step": 1,
            "label": "backend",
            "introduction": "This Python code exposes a FastAPI endpoint that wraps the Docker-based CosmWasm Rust optimizer, letting the frontend (or CI) trigger an on-demand contract build.",
            "code": "################  backend/compile_contract.py  ################\n\"\"\"Compile a CosmWasm contract from a FastAPI endpoint.\"\"\"\nfrom pathlib import Path\nimport subprocess\nfrom fastapi import FastAPI, HTTPException\nfrom pydantic import BaseModel\n\nDOCKER_IMAGE = \"cosmwasm/rust-optimizer:0.12.11\"\n\napp = FastAPI()\n\nclass CompileRequest(BaseModel):\n    project_root: str  # Absolute or relative path to the contract root\n\n\ndef _run_optimizer(project_root: Path) -> str:\n    \"\"\"Internal helper that executes the Docker optimizer and returns stdout.\"\"\"\n    cmd = [\n        \"docker\", \"run\", \"--rm\",\n        \"-v\", f\"{project_root}:/code\",\n        \"--mount\", \"type=volume,source=registry_cache,target=/usr/local/cargo/registry\",\n        DOCKER_IMAGE,\n    ]\n\n    try:\n        result = subprocess.run(cmd, check=True, capture_output=True, text=True)\n    except FileNotFoundError:\n        raise RuntimeError(\"Docker is not installed or not found in PATH.\")\n    except subprocess.CalledProcessError as err:\n        raise RuntimeError(f\"Rust optimizer failed: {err.stderr}\\n{err.stdout}\") from err\n\n    return result.stdout\n\n\n@app.post(\"/api/compile-contract\")\nasync def compile_contract(req: CompileRequest):\n    \"\"\"POST /api/compile-contract with `{ \"project_root\": \"/abs/path\" }` to build the contract.\"\"\"\n    project_root = Path(req.project_root).expanduser().resolve()\n\n    if not project_root.is_dir():\n        raise HTTPException(status_code=400, detail=f\"Directory not found: {project_root}\")\n\n    try:\n        stdout = _run_optimizer(project_root)\n    except Exception as exc:\n        raise HTTPException(status_code=500, detail=str(exc))\n\n    return {\n        \"message\": \"Compilation successful. Artifacts are in ./artifacts/.\",\n        \"stdout\": stdout,\n        \"artifacts_dir\": str(project_root / \"artifacts\")\n    }\n\n# Optional: enable CLI usage for local development\nif __name__ == \"__main__\":\n    import argparse, json, sys\n\n    parser = argparse.ArgumentParser(description=\"Compile CosmWasm contract via docker rust-optimizer.\")\n    parser.add_argument(\"project_root\", help=\"Path to contract root\")\n    args = parser.parse_args()\n\n    try:\n        output = _run_optimizer(Path(args.project_root))\n        print(json.dumps({\"stdout\": output}, indent=2))\n    except Exception as e:\n        print(f\"ERROR: {e}\", file=sys.stderr)\n        sys.exit(1)",
            "usage": "Frontend example:\n\nawait fetch('/api/compile-contract', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({ project_root: '/Users/alice/cosmwasm-mycontract' })\n})\n  .then(r => r.json())\n  .then(console.log)\n  .catch(console.error);"
        },
        {
            "step": 2,
            "label": "backend",
            "introduction": "After compilation, this FastAPI route checks that the ./artifacts directory exists and contains both the compiled .wasm binary and contracts.txt.",
            "code": "################  backend/verify_artifacts.py  ################\n\"\"\"Verify cosmwasm build artifacts exist.\"\"\"\nfrom pathlib import Path\nfrom fastapi import APIRouter, HTTPException\nfrom pydantic import BaseModel\n\nrouter = APIRouter()\n\nclass VerifyRequest(BaseModel):\n    project_root: str\n\n\ndef _verify_artifacts(project_root: Path) -> dict:\n    artifacts_dir = project_root / \"artifacts\"\n\n    if not artifacts_dir.is_dir():\n        raise FileNotFoundError(\"artifacts directory not found \u2014 did the build run?\")\n\n    wasm_files = [f.name for f in artifacts_dir.glob(\"*.wasm\")]\n    if not wasm_files:\n        raise FileNotFoundError(\"No .wasm files found in artifacts directory.\")\n\n    contracts_txt = artifacts_dir / \"contracts.txt\"\n    if not contracts_txt.exists():\n        raise FileNotFoundError(\"contracts.txt not found in artifacts directory.\")\n\n    return {\n        \"wasm_files\": wasm_files,\n        \"contracts_txt\": contracts_txt.name,\n        \"status\": \"verified\"\n    }\n\n\n@router.post(\"/api/verify-artifacts\")\nasync def verify_artifacts(req: VerifyRequest):\n    project_root = Path(req.project_root).expanduser().resolve()\n\n    if not project_root.is_dir():\n        raise HTTPException(status_code=400, detail=f\"Directory not found: {project_root}\")\n\n    try:\n        payload = _verify_artifacts(project_root)\n    except FileNotFoundError as nf:\n        raise HTTPException(status_code=404, detail=str(nf))\n    except Exception as exc:\n        raise HTTPException(status_code=500, detail=str(exc))\n\n    return payload\n\n# Mount router into the FastAPI instance declared in compile_contract.py\n# Example (add this to main entrypoint):\n#   from backend.verify_artifacts import router as verify_router\n#   app.include_router(verify_router)",
            "usage": "Frontend example:\n\nawait fetch('/api/verify-artifacts', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({ project_root: '/Users/alice/cosmwasm-mycontract' })\n})\n  .then(r => r.json())\n  .then(console.log)\n  .catch(console.error);"
        }
    ]
}